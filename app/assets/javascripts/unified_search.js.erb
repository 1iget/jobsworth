UnifiedSearch = (function() {

  var $ = jQuery;

  function UnifiedSearch(input, url, minLength) {
    this.input = input;
    this.url = url;
    this.helperClass = "type_helper" + new Date().valueOf();
    this.minLength = (minLength || 1);

    bindEvents.call(this);
  }

  function bindEvents() {
    var self = this;
    this.input.keyup(function() {
      if (parseInt(self.input.val()) > 0) {
        show.call(self, self.input.val());
      } else if (self.input.val().length < self.minLength) {
        $("img." + self.helperClass + "_spinner").remove();
        $("." + self.helperClass).remove();
        return;
      } else {
        show.call(self, self.input.val());
      }
    }).focusin(function() {
      if (self.input.val().length < self.minLength) return;
      show.call(self, self.input.val());
    })
  }

  function show(term) {
    var self = this;

    // show spinner
    if ($("img." + this.helperClass + "_spinner").length == 0) {
      var offset = self.input.offset();
      var width = self.input.outerWidth();
      var height = self.input.outerHeight();
      var spinner = $("<img src=\"<%= image_path("spinner.gif") %>\" class=\"" + this.helperClass + "_spinner\">")
      spinner.css("position", "absolute")
             .css("left", offset.left + width - 16 + "px")
             .css("top", offset.top + 5 + "px")
             .appendTo('body');
    }

    $.get(this.url, {term: term}, function(res) {
      if (! res.success) return;
      if (self.input.val() != term) return;

      $("." + self.helperClass).remove();

      // hide spinner
      $("img." + self.helperClass + "_spinner").remove();

      // show helper
      var helper = $(res.html);
      var offset = self.input.offset();
      var height = self.input.outerHeight();
      helper.addClass(self.helperClass);
      helper.css("position", "absolute");
      helper.css("left", offset.left + "px");
      helper.css("top", offset.top + height + "px");
      helper.css("display", "block");
      $("body").append(helper);

      var mouse_is_inside = false;
      helper.hover(function(){
        mouse_is_inside=true;
      }, function(){
        mouse_is_inside=false;
      });
      $("body").mouseup(function(){
        if(!mouse_is_inside) helper.remove();
      });
    })
  }

  return UnifiedSearch;
})()
